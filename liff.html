<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>分享</title>
    <script src="https://static.line-scdn.net/liff/sdk/v2/liff.js"></script>
    <style>
        /* 保持你的樣式 */
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 50px 20px;
            background-color: #f5f5f5;
            margin: 0;
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 300px;
            margin: 0 auto;
        }
        
        .message {
            font-size: 16px;
            color: #333;
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="message" id="message">
            載入中...
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const messageElement = document.getElementById('message'); // 預先取得 DOM 元素

        // 用於從多種來源取得 LIFF ID
        function getLiffId() {
            const liffIdFromParam = urlParams.get('liff_id');
            if (liffIdFromParam) {
                return liffIdFromParam;
            }
            // 這是最穩定的獲取 LIFF ID 的方式，因為其他方式可能在 init 前無效
            return '2006562164-aqAKpX42'; // **請務必替換為你的 LIFF ID**
        }

        // 建構分享內容 (async 函數必須用 await 呼叫)
        async function buildShareContent() {
            const messageType = urlParams.get('type');
            
            if (messageType === 'flex') {
                const flexData = urlParams.get('data');
                if (flexData) {
                    try {
                        return [JSON.parse(decodeURIComponent(flexData))];
                    } catch (e) {
                        console.error('Flex JSON 解析失敗:', e);
                        messageElement.textContent = 'Flex 內容解析錯誤！';
                        return null; // 返回 null 表示內容獲取失敗
                    }
                }
                
                const messageId = urlParams.get('id');
                if (messageId) {
                    try {
                        // 請替換成你的實際 API 端點
                        const response = await fetch(`https://your-api.com/flex-messages/${messageId}`); 
                        if (!response.ok) {
                            throw new Error(`HTTP 錯誤! 狀態: ${response.status}`);
                        }
                        const flexMessage = await response.json();
                        return [flexMessage];
                    } catch (e) {
                        console.error('API 取得 Flex 內容失敗:', e);
                        messageElement.textContent = '從 API 獲取 Flex 內容失敗！';
                        return null;
                    }
                }
                
                const template = urlParams.get('template');
                if (template) {
                    const flexTemplates = {
                        'product_card': {
                            type: 'flex',
                            altText: '商品資訊',
                            contents: {
                                type: 'bubble',
                                hero: {
                                    type: 'image',
                                    url: 'https://example.com/product.jpg',
                                    size: 'full',
                                    aspectRatio: '20:13',
                                    aspectMode: 'cover'
                                },
                                body: {
                                    type: 'box',
                                    layout: 'vertical',
                                    contents: [
                                        {
                                            type: 'text',
                                            text: '精選商品',
                                            weight: 'bold',
                                            size: 'xl'
                                        },
                                        {
                                            type: 'text',
                                            text: 'NT$ 1,299',
                                            color: '#ff5551',
                                            weight: 'bold',
                                            size: 'lg'
                                        }
                                    ]
                                }
                            }
                        },
                        'event_info': {
                            type: 'flex',
                            altText: '活動資訊',
                            contents: {
                                type: 'bubble',
                                body: {
                                    type: 'box',
                                    layout: 'vertical',
                                    contents: [
                                        {
                                            type: 'text',
                                            text: '限時活動',
                                            weight: 'bold',
                                            size: 'xl',
                                            color: '#ff5551'
                                        },
                                        {
                                            type: 'text',
                                            text: '立即參加享優惠！',
                                            size: 'md',
                                            margin: 'sm'
                                        }
                                    ]
                                }
                            }
                        }
                    };
                    
                    if (flexTemplates[template]) {
                        return [flexTemplates[template]];
                    } else {
                        console.warn(`未知的 Flex 模板: ${template}`);
                        messageElement.textContent = '未知的 Flex 模板！';
                        return null;
                    }
                }
            }
            
            // 其他類型的處理
            const messageText = urlParams.get('text');
            const imageUrl = urlParams.get('image');
            
            if (messageType === 'text' && messageText) {
                return [{
                    type: 'text',
                    text: decodeURIComponent(messageText)
                }];
            } else if (messageType === 'image' && imageUrl) {
                return [{
                    type: 'image',
                    originalContentUrl: decodeURIComponent(imageUrl),
                    previewImageUrl: decodeURIComponent(imageUrl)
                }];
            } else if (messageType === 'imagemap') {
                try {
                    return [{
                        type: 'imagemap',
                        baseUrl: decodeURIComponent(urlParams.get('baseUrl') || ''),
                        altText: decodeURIComponent(urlParams.get('altText') || 'ImageMap'),
                        baseSize: {
                            width: parseInt(urlParams.get('width') || '1040'),
                            height: parseInt(urlParams.get('height') || '520')
                        },
                        actions: JSON.parse(decodeURIComponent(urlParams.get('actions') || '[]'))
                    }];
                } catch (e) {
                    console.error('Imagemap JSON 解析失敗:', e);
                    messageElement.textContent = 'Imagemap 內容解析錯誤！';
                    return null;
                }
            }
            
            // 預設分享內容 (如果沒有匹配任何參數)
            messageElement.textContent = '使用預設分享內容';
            return [{
                  "type": "imagemap",
                  "actions": [
                    {
                      "area": {
                        "x": 273.41935483870964,
                        "y": 835.6549520766772,
                        "width": 503.225806451613,
                        "height": 176.10223642172534
                      },
                      "type": "uri",
                      "linkUri": "https://sparkprotein.com"
                    }
                  ],
                  "altText": "你是哪種Spark股東？",
                  "baseUrl": "https://img.shoplineapp.com/media/image_clips/683eb2b65133e3000c129998/original.png",
                  "baseSize": {
                    "width": 1040,
                    "height": 1040
                  }
                }];
        }

        // 初始化並執行分享
        async function init() {
            const liffId = getLiffId();
            if (!liffId) {
                messageElement.textContent = '無法獲取 LIFF ID，請檢查 URL 參數或設定。';
                console.error('無法獲取 LIFF ID。');
                return;
            }

            try {
                await liff.init({ liffId: liffId });
                console.log('LIFF 初始化成功！');
                messageElement.textContent = 'LIFF 初始化成功，正在處理分享...';
                
                // 檢查是否已登入
                if (!liff.isLoggedIn()) {
                    console.log('用戶尚未登入，導向登入頁面。');
                    liff.login(); // 導向 LINE 登入頁面
                    return; // 登入後頁面會重新載入，所以這裡直接返回
                }
                
                // 執行分享
                const shareContent = await buildShareContent(); // <-- 這裡需要加 await
                
                if (!shareContent || shareContent.length === 0) {
                    messageElement.textContent = '分享內容無效或無法獲取。';
                    console.error('分享內容無效或無法獲取。');
                    // 這裡可以選擇是否關閉視窗
                    setTimeout(() => {
                        if (liff.isInClient()) {
                            liff.closeWindow();
                        } else {
                            window.close();
                        }
                    }, 1500);
                    return;
                }

                if (liff.isApiAvailable('shareTargetPicker')) {
                    messageElement.textContent = '請選擇分享對象...';
                    const shareResult = await liff.shareTargetPicker(shareContent);
                    
                    if (shareResult) {
                        // shareTargetPicker 成功，但用戶可能取消
                        messageElement.textContent = '分享完成！即將關閉...';
                        console.log('分享結果:', shareResult);
                    } else {
                        // 用戶取消了分享
                        messageElement.textContent = '已取消分享。';
                        console.log('分享已取消。');
                    }
                    
                    // 無論分享成功或取消，都在一段時間後關閉
                    setTimeout(() => {
                        if (liff.isInClient()) {
                            liff.closeWindow();
                        } else {
                            window.close();
                        }
                    }, 1000);
                } else {
                    messageElement.textContent = '您的 LINE 版本不支援分享功能。';
                    console.warn('shareTargetPicker API 不可用。');
                }
                
            } catch (error) {
                let displayMsg = '分享發生未知錯誤。';
                if (error.code === '2') {
                    displayMsg = 'LIFF ID 無效或 Endpoint URL 不匹配。';
                } else if (error.code === '3') {
                    displayMsg = '請在 LINE App 內開啟此頁面。';
                } else if (error.message && error.message.includes('CANCEL')) {
                    displayMsg = '已取消操作。'; // 可能是 shareTargetPicker 或其他取消
                } else {
                    console.error('LIFF 初始化或分享過程發生錯誤:', error);
                    displayMsg += ` (詳情請見 Console)`;
                }
                messageElement.textContent = displayMsg;

                // 即使錯誤，也嘗試關閉視窗以避免無限等待，但給用戶看到錯誤訊息的時間
                setTimeout(() => {
                    if (liff.isInClient()) {
                        liff.closeWindow();
                    } else {
                        // 在瀏覽器中，如果 LIFF 失敗，通常不會自動關閉
                        // 可以考慮提示用戶手動關閉
                    }
                }, 2000); // 延長顯示時間
            }
        }

        // 頁面載入完成後執行
        document.addEventListener('DOMContentLoaded', function() {
            // 檢查 LIFF SDK 是否已載入
            if (typeof liff === 'undefined') {
                messageElement.textContent = 'LIFF SDK 未載入，請檢查網路或重新整理。';
                console.error('LIFF SDK 載入失敗！請確認 <script src="...liff.js"> 是否正確。');
                return;
            }
            
            init(); // 執行初始化和分享邏輯
        });
    </script>
</body>
</html>
