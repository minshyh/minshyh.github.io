<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Line LIFF Redirect App</title>
</head>
<body>
    <div id="loading">載入中...</div>

    <!-- LIFF SDK -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    
    <script>
        // URL 解碼函數
        function decodeURIComponentSafe(uri) {
            try {
                return decodeURIComponent(uri);
            } catch (e) {
                return uri;
            }
        }

        // 從 URL 獲取參數
        function getUrlParameters() {
            const urlParams = new URLSearchParams(window.location.search);
            const params = {};
            
            // 獲取基本參數
            params.liffId = urlParams.get('liffId');
            params.url = urlParams.get('url');
            
            // 獲取 tags 參數（如果存在）
            const tags = urlParams.get('tags');
            if (tags) {
                try {
                    params.tags = JSON.parse(decodeURIComponentSafe(tags));
                } catch (e) {
                    console.error('Error parsing tags:', e);
                    params.tags = [];
                }
            }
            
            return params;
        }

        // 重定向到目標 URL
        async function redirectToTarget(userId, params) {
            try {
                // 建構重定向 API 的請求 URL
                const redirectApiUrl = new URL('https://api.besparks.co/api:G90hiIoE/redirect_v2');
                
                // 添加原始目標 URL
                redirectApiUrl.searchParams.append('url', params.url);
                
                // 添加用戶 ID
                redirectApiUrl.searchParams.append('userId', userId);
                
                // 如果有 tags，添加 tags
                if (params.tags && params.tags.length > 0) {
                    redirectApiUrl.searchParams.append('tags', JSON.stringify(params.tags));
                }

                // 執行重定向
                window.location.href = redirectApiUrl.toString();
            } catch (error) {
                console.error('Redirect error:', error);
                document.getElementById('loading').innerText = '重定向發生錯誤';
            }
        }

        // LIFF 初始化
        async function initializeLiff() {
            try {
                // 獲取 URL 參數
                const params = getUrlParameters();
                
                if (!params.liffId) {
                    throw new Error('缺少 LIFF ID');
                }

                if (!params.url) {
                    throw new Error('缺少目標 URL');
                }

                // 初始化 LIFF
                await liff.init({
                    liffId: params.liffId
                });

                // 檢查是否登入
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }

                // 獲取用戶資料
                const profile = await liff.getProfile();
                
                // 執行重定向
                await redirectToTarget(profile.userId, params);

            } catch (err) {
                console.error('Error:', err);
                document.getElementById('loading').innerText = '發生錯誤：' + err.message;
            }
        }

        // 當網頁載入完成時初始化 LIFF
        window.onload = initializeLiff;
    </script>
</body>
</html>
