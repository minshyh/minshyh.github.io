<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Line LIFF Navigation</title>
</head>
<body>
    <div id="loading">Redirect...</div>

    <!-- LIFF SDK -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    
    <script>
        // 安全的 URL 解碼函數
        function safeDecodeURIComponent(str) {
            try {
                return decodeURIComponent(str);
            } catch (e) {
                return str;
            }
        }

        // 從 URL 獲取參數
        function getUrlParameters() {
            const urlSearchParams = new URLSearchParams(window.location.search);
            const params = {
                liffId: urlSearchParams.get('liffId'),
                url: '',
                extraParams: {}
            };

            // 取得完整的 URL 參數（包含 query string）
            const fullUrl = urlSearchParams.get('url');
            if (fullUrl) {
                // 解碼完整的 URL
                const decodedUrl = safeDecodeURIComponent(fullUrl);
                params.url = decodedUrl;

                // 分析 URL 中的 tags 參數
                try {
                    const targetUrl = new URL(decodedUrl);
                    const tagsParam = targetUrl.searchParams.get('tags');
                    if (tagsParam) {
                        params.extraParams.tags = JSON.parse(safeDecodeURIComponent(tagsParam));
                    }
                } catch (e) {
                    console.error('Error parsing URL or tags:', e);
                }
            }
            
            return params;
        }

        // 發送數據至 Shopline Tag Webhook
        async function sendDataToWebhook(userId, params) {
            try {
                const data = {
                        url: params.url,
                        line_uid: userId,
                        params: params.extraParams
                    };
        
                const response = await fetch('https://api.besparks.co/api:G90hiIoE/redirect/v2', {
                    method: 'POST',
                    body: JSON.stringify(data),
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
        
                if (!response.ok) {
                    throw new Error(`Webhook request failed: ${response.statusText}`);
                }
        
                console.log('Webhook data sent successfully');
            } catch (error) {
                console.error('Error sending webhook data:', error);
            }
        }

        // 執行跳轉
        function performRedirect(url) {
            try {
                // 先嘗試使用 liff.openWindow
                liff.openWindow({
                    url: url,
                    external: false
                });

                // 設置一個備用跳轉
                setTimeout(() => {
                    if (document.getElementById('loading').innerText === 'Redirect...') {
                        console.log('Fallback to window.location');
                        window.location.href = url;
                    }
                }, 1000);
            } catch (error) {
                console.error('Redirect error:', error);
                window.location.href = url;
            }
        }

        // LIFF 初始化
        async function initializeLiff() {
            try {
                // 獲取 URL 參數
                const params = getUrlParameters();
                console.log('Parsed parameters:', params);
                
                if (!params.liffId) {
                    throw new Error('缺少 LIFF ID');
                }

                if (!params.url) {
                    throw new Error('缺少目標 URL');
                }

                // 初始化 LIFF
                await liff.init({
                    liffId: params.liffId
                });

                // 檢查是否登入
                if (!liff.isLoggedIn()) {
                    console.log('User not logged in, redirecting to login');
                    liff.login();
                    return;
                }

                // 獲取用戶資料
                console.log('Getting user profile');
                const profile = await liff.getProfile();
                
                // 並行執行數據發送和跳轉
                console.log('Sending data and redirecting...');
                sendDataToWebhook(profile.userId, params);
                performRedirect(params.url);

            } catch (err) {
                console.error('Error:', err);
                document.getElementById('loading').innerText = '發生錯誤：' + err.message;
            }
        }

        // 當網頁載入完成時初始化 LIFF
        window.onload = initializeLiff;
    </script>
</body>
</html>
