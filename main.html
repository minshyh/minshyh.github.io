<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Line LIFF Navigation</title>
</head>
<body>
    <div id="loading">Redirect...</div>

    <!-- LIFF SDK -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    
    <script>
        // 安全的 URL 解碼函數
        function safeDecodeURIComponent(str) {
            try {
                return decodeURIComponent(str);
            } catch (e) {
                return str;
            }
        }

        function parseQueryString(queryString) {
            const params = {};
            const pairs = queryString.split('&');
            pairs.forEach(pair => {
                const [key, value] = pair.split('=');
                if (key) {
                    params[key] = value ? safeDecodeURIComponent(value) : null;
                }
            });
            return params;
        }

        // 從 URL 獲取參數
       function getUrlParameters(fullUrl) {
            const [basePart, queryPart] = fullUrl.split('?'); // 分離 URL 的 base 和 query
            if (!queryPart) return {}; // 沒有 query 時返回空對象
        
            // 解析第一層參數
            const params = parseQueryString(queryPart);
        
            // 提取並解碼嵌套的 `url` 參數
            if (params.url) {
                const decodedUrl = safeDecodeURIComponent(params.url); // 解碼一次
                params.decodedUrl = decodedUrl;
        
                // 處理嵌套的 `url`，提取其內部參數（如 tags）
                const [targetBasePart, targetQueryPart] = decodedUrl.split('?');
                if (targetQueryPart) {
                    params.targetParams = parseQueryString(targetQueryPart);
                }
            }
        
            return params;
        }

        // 發送數據至 Shopline Tag Webhook
        async function sendDataToWebhook(userId, params) {
            try {
                const data = {
                        url: params.decodedUrl,
                        line_uid: userId,
                        params: params.targetParams.tags
                    };
        
                const response = await fetch('https://api.besparks.co/api:G90hiIoE/redirect/v2', {
                    method: 'POST',
                    body: JSON.stringify(data),
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
        
                if (!response.ok) {
                    throw new Error(`Webhook request failed: ${response.statusText}`);
                }
        
                console.log('Webhook data sent successfully');
            } catch (error) {
                console.error('Error sending webhook data:', error);
            }
        }

        // 執行跳轉
        function performRedirect(url) {
            try {
                // 先嘗試使用 liff.openWindow
                liff.openWindow({
                    url: url,
                    external: false
                });

                // 設置一個備用跳轉
                setTimeout(() => {
                    if (document.getElementById('loading').innerText === 'Redirect...') {
                        console.log('Fallback to window.location');
                        window.location.href = url;
                    }
                }, 1000);
            } catch (error) {
                console.error('Redirect error:', error);
                window.location.href = url;
            }
        }

        // LIFF 初始化
        async function initializeLiff() {
            try {
                // 獲取 URL 參數
                const fullUrl = window.location.href
                const params = getUrlParameters(fullUrl);
                console.log('Parsed parameters:', params);
                
                if (!params.liffId) {
                    throw new Error('缺少 LIFF ID');
                }

                if (!params.decodedUrl) {
                    throw new Error('缺少目標 URL');
                }

                // 初始化 LIFF
                await liff.init({
                    liffId: params.liffId
                });

                // 檢查是否登入
                if (!liff.isLoggedIn()) {
                    console.log('User not logged in, redirecting to login');
                    liff.login();
                    return;
                }

                // 獲取用戶資料
                console.log('Getting user profile');
                const profile = await liff.getProfile();
                
                // 並行執行數據發送和跳轉
                console.log('Sending data and redirecting...');
                sendDataToWebhook(profile.userId, params);
                performRedirect(params.decodedUrl.split('&tags=')[0]);

            } catch (err) {
                console.error('Error:', err);
                document.getElementById('loading').innerText = '發生錯誤：' + err.message;
            }
        }

        // 當網頁載入完成時初始化 LIFF
        window.onload = initializeLiff;
    </script>
</body>
</html>
