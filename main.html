<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Line LIFF Navigation</title>
</head>
<body>
    <div id="loading">Redirect...</div>

    <!-- LIFF SDK -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    
    <script>
        // 從 URL 獲取所有參數
        function getUrlParameters() {
            const urlParams = new URLSearchParams(window.location.search);
            const params = {
                liffId: urlParams.get('liffId'),
                url: urlParams.get('url'),
                extraParams: {}
            };
            
            // 收集除了 liffId 和 url 以外的所有參數
            urlParams.forEach((value, key) => {
                if (key !== 'liffId' && key !== 'url') {
                    // 嘗試解析可能是 JSON 的值
                    try {
                        params.extraParams[key] = JSON.parse(decodeURIComponent(value));
                    } catch (e) {
                        params.extraParams[key] = value;
                    }
                }
            });
            
            return params;
        }

        // 發送資料到 Shopline Tag API
        async function sendDataToShoplineTag(userId, params) {
            try {
                const response = await fetch('https://api.besparks.co/api:G90hiIoE/shopline_tag', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        url: params.url,
                        line_uid: userId,
                        params: params.extraParams
                    })
                });

                if (!response.ok) {
                    throw new Error('API 呼叫失敗');
                }

                return true;
            } catch (error) {
                console.error('API error:', error);
                return false;
            }
        }

        // LIFF 初始化
        async function initializeLiff() {
            try {
                // 獲取 URL 參數
                const params = getUrlParameters();
                
                if (!params.liffId) {
                    throw new Error('缺少 LIFF ID');
                }

                if (!params.url) {
                    throw new Error('缺少目標 URL');
                }

                // 初始化 LIFF
                await liff.init({
                    liffId: params.liffId
                });

                // 檢查是否登入
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }

                // 獲取用戶資料
                const profile = await liff.getProfile();
                
                // 發送資料到 API（不等待回應）
                sendDataToShoplineTag(profile.userId, params);

                // 直接使用 LIFF openWindow 進行跳轉
                liff.openWindow({
                    url: params.url,
                    external: false  // 在外部瀏覽器開啟
                });

            } catch (err) {
                console.error('Error:', err);
                document.getElementById('loading').innerText = '發生錯誤：' + err.message;
            }
        }

        // 當網頁載入完成時初始化 LIFF
        window.onload = initializeLiff;
    </script>
</body>
</html>
